<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EHR Outage Crisis Simulation</title>
  <script defer>
    // Utility Functions
    function copyLink(role) {
      const box = document.getElementById(role + '-link');
      navigator.clipboard.writeText(box.textContent);
      alert('Link copied to clipboard');
    }

    function goToLauncher() {
      switchView('launcher');
    }

    function goToInstructor() {
      switchView('instructor');
    }

    function goToStudent(team) {
      currentTeam = team;
      switchView('student');
      document.getElementById('current-team').textContent = teamRoles[team].name;
      document.getElementById('team-role').textContent = teamRoles[team].description;
      const list = document.getElementById('team-objectives');
      list.innerHTML = '';
      teamRoles[team].objectives.forEach(obj => {
        const li = document.createElement('li');
        li.textContent = obj;
        list.appendChild(li);
      });
    }

    function switchView(view) {
      document.getElementById(currentView).classList.add('hidden');
      document.getElementById(view).classList.remove('hidden');
      currentView = view;
    }

    function populateLinks() {
      const teamDiv = document.getElementById('team-links');
      const instructorBox = document.getElementById('instructor-link');
      instructorBox.textContent = window.location.href + '#instructor';
      teamDiv.innerHTML = '';
      Object.keys(teamRoles).forEach(team => {
        const div = document.createElement('div');
        div.className = 'team-item';
        div.innerHTML = `<div class="team-name">${teamRoles[team].name}</div>
            <div class="link-box">${window.location.href}#${team}</div>
            <button class="btn btn-copy" onclick="navigator.clipboard.writeText('${window.location.href}#${team}')">üìã Copy</button>`;
        teamDiv.appendChild(div);
      });
    }

    function startSimulation() {
      simulationState.isActive = true;
      simulationState.startTime = Date.now();
      simulationTimer = setInterval(updateTime, 1000);
      document.getElementById('start-btn').disabled = true;
      document.getElementById('end-btn').disabled = false;
      enableTriggers();
      document.getElementById('crisis-timer').classList.remove('hidden');
      document.getElementById('status').textContent = 'üî¥ Simulation Active';
    }

    function endSimulation() {
      simulationState.isActive = false;
      clearInterval(simulationTimer);
      document.getElementById('start-btn').disabled = false;
      document.getElementById('end-btn').disabled = true;
      disableTriggers();
      document.getElementById('crisis-timer').classList.add('hidden');
      document.getElementById('status').textContent = 'üü¢ Ready';
    }

    function updateTime() {
      const now = Date.now();
      const elapsed = Math.floor((now - simulationState.startTime) / 1000);
      const mins = String(Math.floor(elapsed / 60)).padStart(2, '0');
      const secs = String(elapsed % 60).padStart(2, '0');
      document.getElementById('elapsed-time').textContent = `${mins}:${secs}`;
      document.getElementById('outage-duration').textContent = Math.floor(elapsed / 60);
    }

    function enableTriggers() {
      ['trauma', 'media', 'vendor', 'recovery'].forEach(id => {
        document.getElementById(id + '-btn').disabled = false;
      });
    }

    function disableTriggers() {
      ['trauma', 'media', 'vendor', 'recovery'].forEach(id => {
        document.getElementById(id + '-btn').disabled = true;
      });
    }

    function triggerEvent(type) {
      const event = crisisEvents[type];
      const alertDiv = document.createElement('div');
      alertDiv.className = 'crisis-alert';
      alertDiv.innerHTML = `<strong>${event.title}</strong><p>${event.description}</p><p><em>${event.impact}</em></p>`;
      document.getElementById('crisis-alerts').prepend(alertDiv);

      const log = document.getElementById('event-log');
      const entry = document.createElement('div');
      entry.className = 'event-notification';
      entry.textContent = `${new Date().toLocaleTimeString()} - ${event.title}`;
      log.prepend(entry);
    }

    window.onload = function () {
  populateLinks();
  const hash = window.location.hash.replace('#', '');
  if (hash === 'instructor') goToInstructor();
  else if (teamRoles[hash]) goToStudent(hash);

  // Initialize chat
  const input = document.getElementById('message-input');
  const sendBtn = document.getElementById('send-btn');
  const chatArea = document.getElementById('chat-area');

  if (input && sendBtn && chatArea) {
    sendBtn.addEventListener('click', () => {
      const msg = input.value.trim();
      if (!msg) return;
      const msgEl = document.createElement('div');
      msgEl.style = 'margin-bottom: 10px; background: #e5e7eb; padding: 10px; border-radius: 5px;';
      msgEl.textContent = `üë§ You: ${msg}`;
      chatArea.appendChild(msgEl);
      input.value = '';
      setTimeout(() => {
        const response = generatePersonaResponse(msg);
        const botEl = document.createElement('div');
        botEl.style = 'margin-bottom: 10px; background: #dbeafe; padding: 10px; border-radius: 5px;';
        botEl.textContent = `üßë‚Äç‚öïÔ∏è Persona: ${response}`;
        chatArea.appendChild(botEl);
        chatArea.scrollTop = chatArea.scrollHeight;
      }, 500);
    });
  }
}

function generatePersonaResponse(input) {
  const responses = [
    "We're under pressure. Can you give me a status update?",
    "This delay is impacting patient care. Any workaround?",
    "Do we have a backup plan in place yet?",
    "Communication is breaking down. Please coordinate with pharmacy.",
    "We need to focus on safety. Keep me posted."
  ];
  return responses[Math.floor(Math.random() * responses.length)];
}
  </script>
</head>
<body>
  <div id="launcher">
    <h1>EHR Outage Crisis Simulation</h1>
    <button onclick="goToInstructor()">Instructor Dashboard</button>
    <div id="team-links"></div>
  </div>

  <div id="instructor" class="hidden">
    <h2>Instructor Dashboard</h2>
    <button onclick="goToLauncher()">Back</button>
    <button id="start-btn" onclick="startSimulation()">Start</button>
    <button id="end-btn" onclick="endSimulation()" disabled>End</button>
    <div id="crisis-timer" class="hidden">
      Crisis Active - <span id="elapsed-time">00:00</span>
    </div>
    <div>
      <button id="trauma-btn" onclick="triggerEvent('trauma')" disabled>Trigger Trauma</button>
      <button id="media-btn" onclick="triggerEvent('media')" disabled>Trigger Media</button>
      <button id="vendor-btn" onclick="triggerEvent('vendor')" disabled>Trigger Vendor</button>
      <button id="recovery-btn" onclick="triggerEvent('recovery')" disabled>Trigger Recovery</button>
    </div>
    <div id="event-log"></div>
  </div>

  <div id="student" class="hidden">
    <h2>Team: <span id="current-team"></span></h2>
    <div>Status: <span id="system-status">CRITICAL</span></div>
    <ul id="team-objectives"></ul>
    <div id="crisis-alerts"></div>
  </div>
</body>
</html>
