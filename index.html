<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EHR Outage Crisis Simulation</title>
  <script defer>
    // Define global state
    let currentView = 'launcher';
    let currentTeam = '';
    let simulationState = {
      isActive: false,
      startTime: null
    };

    const teamRoles = {
      'it_ops': { name: 'IT Operations Command', description: 'Technical coordination team', objectives: ['Restore Epic system', 'Manage incident response'] },
      'clinical': { name: 'Clinical Team', description: 'Patient care team', objectives: ['Maintain patient safety', 'Coordinate clinical workflows'] }
    };

    const crisisEvents = {
      trauma: { title: "ðŸš¨ LEVEL 1 TRAUMA INCOMING", description: "Multi-vehicle accident victims arriving.", impact: "ED overwhelmed, paper workflow needed" },
      media: { title: "ðŸ“º MEDIA INQUIRY", description: "Channel 7 News calling.", impact: "CEO needs talking points" },
      vendor: { title: "ðŸ”§ EPIC VENDOR UPDATE", description: "Epic support timeline: 4-6 hrs.", impact: "Activate downtime procedures" },
      recovery: { title: "âœ… PARTIAL RECOVERY", description: "Lab systems up. Meds still down.", impact: "Mixed pressure on workflows" }
    };

    function copyLink(role) {
      const box = document.getElementById(role + '-link');
      navigator.clipboard.writeText(box.textContent);
      alert('Link copied to clipboard');
    }

    function goToLauncher() {
      switchView('launcher');
    }

    function goToInstructor() {
      switchView('instructor');
    }

    function goToStudent(team) {
      currentTeam = team;
      switchView('student');
      document.getElementById('current-team').textContent = teamRoles[team].name;
      document.getElementById('team-objectives').innerHTML = '';
      teamRoles[team].objectives.forEach(obj => {
        const li = document.createElement('li');
        li.textContent = obj;
        document.getElementById('team-objectives').appendChild(li);
      });
    }

    function switchView(view) {
      document.getElementById(currentView).classList.add('hidden');
      document.getElementById(view).classList.remove('hidden');
      currentView = view;
    }

    function populateLinks() {
      const teamDiv = document.getElementById('team-links');
      const instructorBox = document.getElementById('instructor-link');
      instructorBox.textContent = window.location.href + '#instructor';
      teamDiv.innerHTML = '';
      Object.keys(teamRoles).forEach(team => {
        const div = document.createElement('div');
        div.innerHTML = `<div><strong>${teamRoles[team].name}</strong></div>
            <div class="link-box">${window.location.href}#${team}</div>`;
        teamDiv.appendChild(div);
      });
    }

    function startSimulation() {
      simulationState.isActive = true;
      simulationState.startTime = Date.now();
      document.getElementById('start-btn').disabled = true;
      document.getElementById('end-btn').disabled = false;
      enableTriggers();
      document.getElementById('crisis-timer').classList.remove('hidden');
    }

    function endSimulation() {
      simulationState.isActive = false;
      document.getElementById('start-btn').disabled = false;
      document.getElementById('end-btn').disabled = true;
      disableTriggers();
      document.getElementById('crisis-timer').classList.add('hidden');
    }

    function enableTriggers() {
      ['trauma', 'media', 'vendor', 'recovery'].forEach(id => {
        document.getElementById(id + '-btn').disabled = false;
      });
    }

    function disableTriggers() {
      ['trauma', 'media', 'vendor', 'recovery'].forEach(id => {
        document.getElementById(id + '-btn').disabled = true;
      });
    }

    function triggerEvent(type) {
      const event = crisisEvents[type];
      const alertDiv = document.createElement('div');
      alertDiv.className = 'crisis-alert';
      alertDiv.innerHTML = `<strong>${event.title}</strong><p>${event.description}</p><p><em>${event.impact}</em></p>`;
      document.getElementById('crisis-alerts').prepend(alertDiv);

      const log = document.getElementById('event-log');
      const entry = document.createElement('div');
      entry.className = 'event-notification';
      entry.textContent = `${new Date().toLocaleTimeString()} - ${event.title}`;
      log.prepend(entry);
    }

    window.onload = function () {
      populateLinks();
      const hash = window.location.hash.replace('#', '');
      if (hash === 'instructor') goToInstructor();
      else if (teamRoles[hash]) goToStudent(hash);
    }
  </script>
</head>
<body>
  <div id="launcher">
    <h1>EHR Outage Crisis Simulation</h1>
    <button onclick="goToInstructor()">Instructor Dashboard</button>
    <div id="instructor-link"></div>
    <div id="team-links"></div>
  </div>

  <div id="instructor" class="hidden">
    <h2>Instructor Dashboard</h2>
    <button onclick="goToLauncher()">Back</button>
    <button id="start-btn" onclick="startSimulation()">Start</button>
    <button id="end-btn" onclick="endSimulation()" disabled>End</button>
    <div id="crisis-timer" class="hidden">
      Crisis Active - <span id="elapsed-time">00:00</span>
    </div>
    <div>
      <button id="trauma-btn" onclick="triggerEvent('trauma')" disabled>Trigger Trauma</button>
      <button id="media-btn" onclick="triggerEvent('media')" disabled>Trigger Media</button>
      <button id="vendor-btn" onclick="triggerEvent('vendor')" disabled>Trigger Vendor</button>
      <button id="recovery-btn" onclick="triggerEvent('recovery')" disabled>Trigger Recovery</button>
    </div>
    <div id="event-log"></div>
  </div>

  <div id="student" class="hidden">
    <h2>Team: <span id="current-team"></span></h2>
    <div>Status: <span id="system-status">CRITICAL</span></div>
    <ul id="team-objectives"></ul>
    <div id="crisis-alerts"></div>
  </div>
</body>
</html>
