<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EHR Outage Crisis Simulation</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        .header h1 {
            color: #2563eb;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        .card {
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 25px;
            background: #f9fafb;
        }
        .card h2 {
            margin: 0 0 15px 0;
            font-size: 1.5rem;
        }
        .instructor-card {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        .instructor-card h2 {
            color: #1d4ed8;
        }
        .student-card {
            border-color: #10b981;
            background: #ecfdf5;
        }
        .student-card h2 {
            color: #047857;
        }
        .link-box {
            background: white;
            border: 1px solid #d1d5db;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 0.9rem;
            margin: 10px 0;
            word-break: break-all;
        }
        .btn {
            display: inline-block;
            padding: 10px 20px;
            background: #3b82f6;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            margin: 5px 5px 5px 0;
        }
        .btn:hover {
            background: #2563eb;
        }
        .btn-green {
            background: #10b981;
        }
        .btn-green:hover {
            background: #059669;
        }
        .btn-copy {
            background: #6b7280;
            padding: 5px 10px;
            font-size: 0.8rem;
        }
        .team-item {
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
        }
        .team-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .instructions {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
        }
        .instructions h3 {
            color: #92400e;
            margin-top: 0;
        }
        .hidden {
            display: none;
        }
        .status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            background: #10b981;
            color: white;
            border-radius: 20px;
            font-size: 0.8rem;
        }
        .crisis-alert {
            background: #fef2f2;
            border: 2px solid #dc2626;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        .event-notification {
            background: #fbbf24;
            color: #92400e;
            padding: 10px 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        .simulation-controls {
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        .timer {
            background: #dc2626;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            text-align: center;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="status" id="status">üü¢ Ready</div>
    
    <div class="container">
        <!-- Launcher View -->
        <div id="launcher">
            <div class="header">
                <h1>üè• EHR Outage Crisis Simulation</h1>
                <p style="font-size: 1.2rem; color: #6b7280;">Multi-User Classroom Environment</p>
                <p style="color: #9ca3af;">Healthcare IT Crisis Management Training</p>
            </div>

            <div class="grid">
                <div class="card instructor-card">
                    <h2>‚öôÔ∏è Instructor Access</h2>
                    <p>Dashboard for simulation setup, monitoring, and scoring.</p>
                    
                    <div style="margin: 15px 0;">
                        <strong>Instructor Link:</strong>
                        <div class="link-box" id="instructor-link">Loading...</div>
                        <button class="btn btn-copy" onclick="copyLink('instructor')">üìã Copy Link</button>
                    </div>
                    
                    <button class="btn" onclick="goToInstructor()">üéõÔ∏è Open Instructor Dashboard</button>
                </div>

                <div class="card student-card">
                    <h2>üë• Student Team Links</h2>
                    <p>Direct links for each team role. Share one link per team.</p>
                    
                    <div id="team-links">
                        <!-- Team links will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <div class="instructions">
                <h3>üìã Classroom Setup Instructions</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h4>For Instructors:</h4>
                        <ul>
                            <li>Copy the instructor link above and bookmark it</li>
                            <li>Access the simulation dashboard</li>
                            <li>Configure settings and start the simulation</li>
                            <li>Monitor teams and trigger crisis events</li>
                        </ul>
                    </div>
                    <div>
                        <h4>For Students:</h4>
                        <ul>
                            <li>Each team gets their specific link above</li>
                            <li>Students access their team's dedicated interface</li>
                            <li>Interact with personas and coordinate response</li>
                            <li>Focus on patient safety and team collaboration</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Instructor View -->
        <div id="instructor" class="hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h1 style="color: #1d4ed8;">Instructor Dashboard</h1>
                <button class="btn" onclick="goToLauncher()">‚Üê Back to Launcher</button>
            </div>

            <div id="crisis-timer" class="timer hidden">
                ‚è±Ô∏è Crisis Active: <span id="elapsed-time">00:00</span> | Severity: <span id="crisis-level">CRITICAL</span>
            </div>

            <div class="grid">
                <div class="card">
                    <h2>Simulation Control</h2>
                    <div class="simulation-controls">
                        <div style="margin: 20px 0;">
                            <label><strong>Duration:</strong></label>
                            <select id="duration-select" style="width: 100%; padding: 8px; margin: 5px 0;">
                                <option value="120">2 hours (recommended)</option>
                                <option value="90">90 minutes</option>
                                <option value="180">3 hours</option>
                            </select>
                        </div>
                        <div style="margin: 20px 0;">
                            <label><strong>Difficulty:</strong></label>
                            <select id="difficulty-select" style="width: 100%; padding: 8px; margin: 5px 0;">
                                <option value="medium">Medium - Realistic pressure</option>
                                <option value="easy">Easy - Guided responses</option>
                                <option value="hard">Hard - High stress</option>
                            </select>
                        </div>
                        <button class="btn btn-green" style="width: 100%; padding: 15px;" onclick="startSimulation()" id="start-btn">üöÄ Start Crisis Simulation</button>
                        <button class="btn" style="width: 100%; padding: 15px; background: #dc2626;" onclick="endSimulation()" id="end-btn" disabled>üõë End Simulation</button>
                    </div>
                </div>

                <div class="card">
                    <h2>Crisis Triggers</h2>
                    <button class="btn" style="width: 100%; background: #f59e0b; margin: 5px 0;" onclick="triggerEvent('trauma')" disabled id="trauma-btn">üö® Trauma Patient Arrival</button>
                    <button class="btn" style="width: 100%; background: #8b5cf6; margin: 5px 0;" onclick="triggerEvent('media')" disabled id="media-btn">üì∫ Media Inquiry</button>
                    <button class="btn" style="width: 100%; background: #ef4444; margin: 5px 0;" onclick="triggerEvent('vendor')" disabled id="vendor-btn">üîß Epic Vendor Update</button>
                    <button class="btn" style="width: 100%; background: #059669; margin: 5px 0;" onclick="triggerEvent('recovery')" disabled id="recovery-btn">‚úÖ Partial System Recovery</button>
                </div>
            </div>

            <div class="card" style="margin-top: 20px;">
                <h2>Team Overview & Activity</h2>
                <div id="team-status">
                    <!-- Team status will be populated by JavaScript -->
                </div>
            </div>

            <div class="card" style="margin-top: 20px;">
                <h2>Live Event Log</h2>
                <div id="event-log" style="max-height: 200px; overflow-y: auto; background: #f9fafb; padding: 10px; border: 1px solid #d1d5db; border-radius: 5px;">
                    <div style="color: #6b7280; text-align: center;">No events yet. Start the simulation to begin logging.</div>
                </div>
            </div>
        </div>

        <!-- Student View -->
        <div id="student" class="hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <div>
                    <h1 style="color: #dc2626;">‚ö†Ô∏è EHR SYSTEM OUTAGE - ACTIVE</h1>
                    <p style="color: #6b7280; font-size: 1.1rem;">Team: <span id="current-team">Loading...</span></p>
                </div>
                <button class="btn" onclick="goToLauncher()">‚Üê Exit Simulation</button>
            </div>

            <div id="simulation-not-started" class="card" style="background: #fef3c7; text-align: center;">
                <h3>‚è≥ Waiting for Instructor to Start Simulation</h3>
                <p>Your instructor hasn't started the crisis simulation yet. Please wait...</p>
                <div style="margin: 20px 0;">
                    <div style="display: inline-block; width: 20px; height: 20px; border: 3px solid #f59e0b; border-top: 3px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                </div>
            </div>

            <div id="simulation-active" class="hidden">
                <div id="crisis-alerts"></div>

                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div style="background: #fef2f2; border-left: 4px solid #dc2626; padding: 15px;">
                        <div style="font-weight: bold;">üïê Crisis Time</div>
                        <div style="font-size: 1.2rem; font-weight: bold;" id="student-timer">07:30 AM</div>
                        <div style="font-size: 0.9rem; color: #6b7280;">Outage: <span id="outage-duration">0</span> minutes</div>
                    </div>
                    <div style="background: #fff7ed; border-left: 4px solid #f97316; padding: 15px;">
                        <div style="font-weight: bold;">üë• Status</div>
                        <div style="font-weight: bold; color: #dc2626;" id="system-status">CRITICAL</div>
                    </div>
                    <div style="background: #eff6ff; border-left: 4px solid #3b82f6; padding: 15px;">
                        <div style="font-weight: bold;">üéØ Your Role</div>
                        <div style="font-size: 0.9rem;" id="team-role">Loading...</div>
                    </div>
                </div>

                <div class="card" style="background: #fef3c7;">
                    <h3>üéØ Your Team Objectives:</h3>
                    <ul id="team-objectives">
                        <!-- Objectives will be populated by JavaScript -->
                    </ul>
                </div>

                <div class="grid" style="margin-top: 20px;">
                    <div class="card">
                        <h3>Available Personas</h3>
                        <div id="persona-list">
                            <!-- Personas will be populated by JavaScript -->
                        </div>
                    </div>

                    <div class="card">
                        <h3>Crisis Communication</h3>
                        <div style="border: 1px solid #d1d5db; height: 300px; padding: 10px; background: #f9fafb; overflow-y: auto;" id="chat-area">
                            <div style="text-align: center; color: #6b7280; margin-top: 120px;">
                                Select a persona and start gathering information about the crisis...
                                <div style="margin-top: 10px; font-size: 0.9rem;">
                                    üí° Try asking: "What's your current situation?" or "How can we help?"
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 10px; display: flex; gap: 10px;">
                            <input type="text" id="message-input" placeholder="Select a persona first..." style="flex: 1; padding: 8px; border: 1px solid #d1d5db; border-radius: 5px;" disabled>
                            <button class="btn" onclick="sendMessage()" disabled id="send-btn">Send</button>
                        </div>
                        <div id="persona-info" style="margin-top: 10px; padding: 10px; background: #fef3c7; border-left: 4px solid #f59e0b; font-size: 0.9rem; display: none;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Enhanced simulation state management
        let simulationState = {
            isActive: false,
            startTime: null,
            duration: 120,
            difficulty: 'medium',
            events: [],
            severity: 'CRITICAL',
            triggeredEvents: [],
            systemStatus: 'DOWN'
        };

        // Team and persona data
        const teamRoles = {
            'it_ops': {
                name: 'IT Operations Command',
                description: 'Overall incident response coordination and technical leadership',
                objectives: ['Restore Epic system', 'Coordinate incident response', 'Manage technical resources']
            },
            'clinical_informatics': {
                name: 'Clinical Informatics',
                description: 'Clinical workflow and safety protocols during downtime',
                objectives: ['Ensure patient safety', 'Coordinate downtime procedures', 'Manage clinical workflows']
            },
            'help_desk': {
                name: 'Help Desk & Support',
                description: 'End-user support and communication coordination',
                objectives: ['Support clinical staff', 'Manage user communications', 'Document issues']
            },
            'executive': {
                name: 'Executive Leadership',
                description: 'Strategic decisions and external communication',
                objectives: ['Manage stakeholder communication', 'Make strategic decisions', 'Handle media/regulatory']
            },
            'clinical_depts': {
                name: 'Clinical Departments',
                description: 'Represent ICU, ED, Surgery, and Pharmacy needs',
                objectives: ['Advocate for department needs', 'Implement workarounds', 'Maintain patient care']
            },
            'infrastructure': {
                name: 'Network & Infrastructure',
                description: 'Technical troubleshooting and system recovery',
                objectives: ['Diagnose technical issues', 'Implement recovery procedures', 'Coordinate with vendors']
            }
        };

        // Enhanced personas with dynamic responses
        const personas = {
            'dr_chen_icu': {
                name: 'Dr. Sarah Chen',
                title: 'ICU Director',
                role: 'Critical Care Physician',
                description: 'Managing 24 ICU patients, frustrated about medication orders',
                stress_level: 'High',
                priorities: ['Patient safety', 'Medication administration', 'Ventilator management'],
                personality: 'direct, clinically focused, impatient with technical delays',
                responses: {
                    greeting: "This is Dr. Chen from ICU. We have 24 patients and I can't access any medication records. This is critical.",
                    situation: "Every minute without Epic puts lives at risk. I have patients on continuous drips that need precise dosing. My nurses are overwhelmed with paper charts.",
                    help: "I need Epic back online NOW. If that's not possible, give me a reliable way to access medication histories and current orders.",
                    timeline: "How long? Because I have three patients who need immediate medication adjustments. Paper charts don't show interaction warnings.",
                    pressure: "Look, I don't care about your technical problems. I care about keeping people alive. What's your backup plan?"
                }
            },
            'nurse_williams': {
                name: 'Manager Williams',
                title: 'ED Nurse Manager',
                role: 'Emergency Department Nurse Manager',
                description: 'Coordinating 15 nurses during busy morning shift',
                stress_level: 'Very High',
                priorities: ['Patient flow', 'Documentation', 'Staff coordination'],
                personality: 'overwhelmed, practical, team-focused',
                responses: {
                    greeting: "Williams here from ED. We're drowning without Epic. Fifteen nurses asking me questions I can't answer.",
                    situation: "We have a trauma coming in 5 minutes and nowhere to document vitals or allergies. My staff is panicking.",
                    help: "We need clear protocols for paper documentation and a way to communicate with other departments without Epic messaging.",
                    timeline: "My nurses need to know NOW - are we doing full paper backup? Do we have enough forms? Who's coordinating with pharmacy?",
                    pressure: "This is chaos. I have new grads who've never worked without computers. Can you send someone to help with workflows?"
                }
            },
            'ceo_martinez': {
                name: 'CEO Martinez',
                title: 'Chief Executive Officer',
                role: 'Hospital CEO',
                description: 'Concerned about reputation, costs, and regulatory compliance',
                stress_level: 'Medium',
                priorities: ['Public relations', 'Financial impact', 'Board communication'],
                personality: 'strategic, concerned about reputation, business-focused',
                responses: {
                    greeting: "Martinez here. I need a full briefing on this outage. The board is asking questions and I need answers.",
                    situation: "How widespread is this? Are other hospitals affected? I'm getting calls from the media already.",
                    help: "I need talking points for the board meeting in an hour. What's our communication strategy? Are we notifying patients?",
                    timeline: "The longer this goes, the worse it looks. What's our worst-case scenario? Do we need to activate disaster protocols?",
                    pressure: "This could be front page news. I need hourly updates and a clear action plan I can present to stakeholders."
                }
            },
            'cio_johnson': {
                name: 'David Johnson',
                title: 'Chief Information Officer',
                role: 'CIO',
                description: 'Leading incident response, managing IT team, fielding calls from all departments',
                stress_level: 'Very High',
                priorities: ['System restoration', 'Incident command', 'Stakeholder communication'],
                personality: 'technical, under pressure, coordinating multiple efforts',
                responses: {
                    greeting: "Johnson, CIO. I'm running the incident response. Epic's primary datacenter lost power. Generators failed.",
                    situation: "We're coordinating with Epic support, our vendors, and internal teams. Backup systems are overwhelmed with the load.",
                    help: "Keep your teams focused on patient safety protocols. We're working multiple recovery paths simultaneously.",
                    timeline: "Epic estimates 4-6 hours for full restoration. We might get partial systems back in 2-3 hours if the generator issue is resolved.",
                    pressure: "This is our worst-case scenario. I need all departments to activate their downtime procedures immediately."
                }
            }
        };

        // Crisis events that can be triggered
        const crisisEvents = {
            trauma: {
                title: "üö® LEVEL 1 TRAUMA INCOMING",
                description: "Multi-vehicle accident victims arriving in 3 minutes. Critical documentation needed.",
                impact: "ED overwhelmed, immediate paper workflow required"
            },
            media: {
                title: "üì∫ MEDIA INQUIRY",
                description: "Channel 7 News calling about 'computer problems' affecting patient care.",
                impact: "Public relations crisis, CEO needs immediate talking points"
            },
            vendor: {
                title: "üîß EPIC VENDOR UPDATE",
                description: "Epic support provides recovery timeline: 4-6 hours for full restoration.",
                impact: "Long-term downtime procedures must be activated"
            },
            recovery: {
                title: "‚úÖ PARTIAL RECOVERY",
                description: "Lab systems coming back online. Medication orders still down.",
                impact: "Mixed relief and continued pressure on clinical workflows"
            }
        };

        // Global variables
        let currentView = 'launcher';
        let currentTeam = '';
        let selectedPersona = '';
        let messages = [];
        let simulationTimer = null;
